<!--
////////////////////////////////////////////////////////////////////////////
//
// Epoxy - An independent flexible XAML MVVM library for .NET
// Copyright (c) 2019-2021 Kouji Matsui (@kozy_kekyo, @kekyo2)
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//	http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
////////////////////////////////////////////////////////////////////////////
-->
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    
  <UsingTask
    TaskName="GetCombinedReferencesBasePath"
    TaskFactory="RoslynCodeTaskFactory"
    AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <References ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <CombinedReferencesBasePath Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System"/>
      <Using Namespace="System.IO"/>
      <Using Namespace="System.Linq"/>
      <Using Namespace="Microsoft.Build.Framework"/>
      <Code Type="Fragment" Language="cs">
<![CDATA[
        CombinedReferencesBasePath = string.Join(";", References.
            Where(item => !string.IsNullOrWhitespace(item.ItemSpec)).
            GroupBy(item => Path.GetDirectoryName(Path.GetFullPath(item.ItemSpec))).
            Select(g => g.Key).
            Distinct());
]]>
      </Code>
    </Task>
  </UsingTask>
    
  <Target Name="EpoxyBuild" BeforeTargets="AfterCompile">
    <GetCombinedReferencesBasePath References="@(ReferencePath)">
        <Output TaskParameter="CombinedReferencesBasePath" PropertyName="CombinedReferencesBasePath" />
    </GetCombinedReferencesBasePath>
        
    <Exec WorkingDirectory="$(EpoxyBuildToolingDir)"
          Command="$(EpoxyBuildToolingRuntimeName)&quot;$(EpoxyBuildToolingPath)&quot; &quot;$(CombinedReferencesBasePath)&quot; &quot;$(TargetPath)&quot;" />
  </Target>
</Project>
